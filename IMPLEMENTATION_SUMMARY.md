# è¯„è®ºåŠŸèƒ½å®ç°æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡å®ç°ä¸º Tiptap 3 + Yjs åä½œç¼–è¾‘å™¨æ·»åŠ äº†å®Œæ•´çš„è¯„è®ºåŠŸèƒ½,å‚è€ƒäº† [tiptap-comment-extension](https://github.com/sereneinserenade/tiptap-comment-extension) çš„è®¾è®¡,å¹¶å®Œå…¨é›†æˆäº† Yjs ååŒç¼–è¾‘èƒ½åŠ›ã€‚

## å®ç°çš„æ–‡ä»¶

### 1. æ ¸å¿ƒæ‰©å±•æ–‡ä»¶

#### `src/extensions/comment.js` - è¯„è®º Mark æ‰©å±•
- åŸºäº Tiptap Mark å®ç°
- å®šä¹‰è¯„è®ºçš„æ•°æ®ç»“æ„å’Œå±æ€§ (`commentId`)
- å®ç°è¯„è®ºæ ‡è®°çš„ HTML è§£æå’Œæ¸²æŸ“
- æä¾›å‘½ä»¤: `setComment`, `unsetComment`, `toggleComment`
- æ·»åŠ é”®ç›˜å¿«æ·é”® `Ctrl+Shift+M`
- ç›‘å¬é€‰åŒºå˜åŒ–,è‡ªåŠ¨æ›´æ–°æ¿€æ´»çš„è¯„è®º

#### `src/extensions/commentManager.js` - è¯„è®ºæ•°æ®ç®¡ç†
- ä½¿ç”¨ Yjs Map (`ydoc.getMap('comments')`) å­˜å‚¨è¯„è®ºæ•°æ®
- å®ç°è¯„è®ºçš„å¢åˆ æ”¹æŸ¥æ“ä½œ
- æ”¯æŒè¯„è®ºå›å¤åŠŸèƒ½
- è‡ªåŠ¨åŒæ­¥è¯„è®ºæ•°æ®åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
- æä¾›å›è°ƒæœºåˆ¶ç›‘å¬è¯„è®ºå˜åŒ–

#### `src/extensions/commentUI.js` - è¯„è®ºç•Œé¢ç»„ä»¶
- åˆ›å»ºå›ºå®šåœ¨å³ä¾§çš„è¯„è®ºé¢æ¿
- æ¸²æŸ“è¯„è®ºåˆ—è¡¨å’Œå›å¤
- å®ç°è¯„è®ºçš„æ¿€æ´»ã€ç¼–è¾‘ã€åˆ é™¤åŠŸèƒ½
- æ”¯æŒè¯„è®ºå®šä½(è·³è½¬åˆ°å¯¹åº”æ–‡æœ¬)
- å¯æŠ˜å /å±•å¼€é¢æ¿
- å‹å¥½çš„æ—¶é—´æ˜¾ç¤ºå’Œç”¨æˆ·å¤´åƒ

### 2. ä¸»æ–‡ä»¶ä¿®æ”¹

#### `src/main.js`
- å¯¼å…¥è¯„è®ºç›¸å…³æ¨¡å—
- åˆ›å»º CommentManager å®ä¾‹
- é…ç½® Comment æ‰©å±•
- åˆå§‹åŒ– CommentUI
- æ·»åŠ è¯„è®ºæŒ‰é’®åˆ°å·¥å…·æ 
- æ¸…ç†èµ„æºæ—¶é”€æ¯è¯„è®ºç»„ä»¶

#### `index.html`
- åœ¨å·¥å…·æ æ·»åŠ  "ğŸ’¬ è¯„è®º" æŒ‰é’®

#### `src/styles.css`
- è¯„è®ºæ ‡è®°æ ·å¼ (`.tiptap-comment`)
- è¯„è®ºé¢æ¿æ ·å¼ (`.comment-sidebar`)
- è¯„è®ºé¡¹æ ·å¼ (`.comment-item`)
- å›å¤æ ·å¼ (`.comment-reply`)
- å“åº”å¼è®¾è®¡

### 3. æ–‡æ¡£æ–‡ä»¶

#### `COMMENT_GUIDE.md` - æŠ€æœ¯æ–‡æ¡£
- åŠŸèƒ½æ¦‚è¿°å’Œç‰¹æ€§åˆ—è¡¨
- ä½¿ç”¨æ–¹æ³•è¯´æ˜
- æŠ€æœ¯å®ç°ç»†èŠ‚
- API å‚è€ƒæ–‡æ¡£
- æ ·å¼å®šåˆ¶æŒ‡å—

#### `COMMENT_USAGE.md` - ä½¿ç”¨ç¤ºä¾‹
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- æµ‹è¯•åœºæ™¯æ¼”ç¤º
- æ•…éšœæ’é™¤
- å¸¸è§é—®é¢˜è§£ç­”

#### `TESTING.md` - æµ‹è¯•æŒ‡å—
- è¯¦ç»†æµ‹è¯•æ­¥éª¤
- é¢„æœŸç»“æœæ£€æŸ¥
- æ€§èƒ½æµ‹è¯•æŒ‡å—
- æˆåŠŸæ ‡å‡†

#### `README.md` - æ›´æ–°
- æ·»åŠ è¯„è®ºåŠŸèƒ½äº®ç‚¹
- æ›´æ–°é¡¹ç›®ç»“æ„
- æ·»åŠ ä½¿ç”¨æŒ‡å—é“¾æ¥
- è¡¥å……æŠ€æœ¯å®ç°è¯´æ˜

## æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

### 1. Yjs é›†æˆ

è¯„è®ºæ•°æ®é€šè¿‡ Yjs Map å­˜å‚¨å’ŒåŒæ­¥:

```javascript
// æ•°æ®å­˜å‚¨åœ¨ Yjs Map ä¸­
const commentsMap = ydoc.getMap('comments')

// ç›‘å¬å˜åŒ–
commentsMap.observe((event) => {
  // è‡ªåŠ¨è§¦å‘æ‰€æœ‰å®¢æˆ·ç«¯æ›´æ–°
})

// ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§
ydoc.transact(() => {
  commentsMap.set(commentId, commentData)
})
```

### 2. Tiptap Mark å®ç°

è¯„è®ºé€šè¿‡ Mark æ ‡è®°å®ç°:

```javascript
// æ·»åŠ è¯„è®ºæ ‡è®°
editor.commands.setComment(commentId)

// Mark å±æ€§
attrs: {
  commentId: {
    parseHTML: (el) => el.getAttribute('data-comment-id'),
    renderHTML: (attrs) => ({ 'data-comment-id': attrs.commentId })
  }
}
```

### 3. å®æ—¶åŒæ­¥æœºåˆ¶

- Yjs ä½¿ç”¨ CRDT ç®—æ³•è‡ªåŠ¨å¤„ç†å†²çª
- WebSocket Provider å®ç°ä½å»¶è¿ŸåŒæ­¥
- è§‚å¯Ÿè€…æ¨¡å¼ç›‘å¬æ•°æ®å˜åŒ–
- è‡ªåŠ¨æ›´æ–° UI æ˜¾ç¤º

### 4. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- ç‚¹å‡»è¯„è®ºè‡ªåŠ¨å®šä½åˆ°æ–‡æœ¬
- æ¿€æ´»è¯„è®ºæ—¶èšç„¦è¾“å…¥æ¡†
- è¯„è®ºæ—¶é—´æ™ºèƒ½æ˜¾ç¤º
- ç”¨æˆ·å¤´åƒé¢œè‰²æ ‡è¯†
- å¹³æ»‘çš„æ»šåŠ¨åŠ¨ç”»

## åŠŸèƒ½ç‰¹æ€§

âœ… **å·²å®ç°**:
- æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤è¯„è®º
- è¯„è®ºå›å¤åŠŸèƒ½
- å¤šäººååŒæ— å†²çª
- è¯„è®ºå®šä½
- å¿«æ·é”®æ”¯æŒ
- è¯„è®ºé¢æ¿ UI
- å®æ—¶åŒæ­¥
- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

ğŸš§ **æœªæ¥å¯æ‰©å±•**:
- å¯Œæ–‡æœ¬è¯„è®º
- è¯„è®ºçº¿ç¨‹(åµŒå¥—å›å¤)
- è¯„è®ºè§£å†³çŠ¶æ€
- @æåŠç”¨æˆ·
- è¯„è®ºå¯¼å‡º
- è¯„è®ºæœç´¢è¿‡æ»¤
- è¯„è®ºæƒé™æ§åˆ¶

## æµ‹è¯•å»ºè®®

1. **åŸºæœ¬åŠŸèƒ½æµ‹è¯•**
   - æ·»åŠ /ç¼–è¾‘/åˆ é™¤è¯„è®º
   - æ·»åŠ å›å¤
   - è¯„è®ºå®šä½

2. **ååŒæµ‹è¯•**
   - å¤šä¸ªæ ‡ç­¾é¡µåŒæ—¶æ“ä½œ
   - éªŒè¯å®æ—¶åŒæ­¥
   - æ£€æŸ¥å†²çªå¤„ç†

3. **æ€§èƒ½æµ‹è¯•**
   - å¤§é‡è¯„è®ºæ€§èƒ½
   - é•¿æ–‡æ¡£æ»šåŠ¨
   - å†…å­˜å ç”¨

4. **å…¼å®¹æ€§æµ‹è¯•**
   - ä¸åŒæµè§ˆå™¨
   - ç§»åŠ¨ç«¯å“åº”å¼
   - ç½‘ç»œå»¶è¿Ÿæƒ…å†µ

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿä¸Šæ‰‹

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨ WebSocket æœåŠ¡å™¨
npm run server

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

### æ·»åŠ è¯„è®º

1. é€‰ä¸­æ–‡æœ¬
2. ç‚¹å‡» "ğŸ’¬ è¯„è®º" æˆ–æŒ‰ `Ctrl+Shift+M`
3. è¾“å…¥è¯„è®ºå†…å®¹

### API ä½¿ç”¨

```javascript
// æ·»åŠ è¯„è®º
const commentId = commentManager.addComment('è¯„è®ºå†…å®¹')
editor.commands.setComment(commentId)

// æ›´æ–°è¯„è®º
commentManager.updateComment(commentId, 'æ–°å†…å®¹')

// åˆ é™¤è¯„è®º
commentManager.deleteComment(commentId)
editor.commands.unsetComment(commentId)

// æ·»åŠ å›å¤
commentManager.addReply(commentId, 'å›å¤å†…å®¹')
```

## æ¶æ„è®¾è®¡

```
ç”¨æˆ·æ“ä½œ
    â†“
CommentUI (ç•Œé¢å±‚)
    â†“
CommentManager (æ•°æ®å±‚)
    â†“
Yjs Map (åŒæ­¥å±‚)
    â†“
WebSocket Provider (ä¼ è¾“å±‚)
    â†“
å…¶ä»–å®¢æˆ·ç«¯
```

## ä¾èµ–å…³ç³»

- `comment.js` â†’ Tiptap Core (Mark)
- `commentManager.js` â†’ Yjs (Map)
- `commentUI.js` â†’ Editor + CommentManager
- `main.js` â†’ æ‰€æœ‰æ¨¡å—

## æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæ•´åœ°å‚è€ƒäº† tiptap-comment-extension çš„è®¾è®¡æ€è·¯,å¹¶åœ¨ä»¥ä¸‹æ–¹é¢è¿›è¡Œäº†æ”¹è¿›:

1. **å®Œå…¨é›†æˆ Yjs**: è¯„è®ºæ•°æ®é€šè¿‡ Yjs ååŒ,è€Œéç‹¬ç«‹å­˜å‚¨
2. **ç®€åŒ–æ¥å£**: æä¾›æ›´ç®€æ´çš„ API å’Œä½¿ç”¨æ–¹å¼
3. **ä¼˜åŒ– UI**: æ›´å‹å¥½çš„ç•Œé¢è®¾è®¡å’Œäº¤äº’ä½“éªŒ
4. **æ–‡æ¡£å®Œå–„**: æä¾›è¯¦ç»†çš„ä½¿ç”¨å’ŒæŠ€æœ¯æ–‡æ¡£

æ•´ä¸ªå®ç°éµå¾ªäº† Tiptap çš„æ‰©å±•æ¨¡å¼å’Œ Yjs çš„æ•°æ®åŒæ­¥æœºåˆ¶,ç¡®ä¿äº†åŠŸèƒ½çš„ç¨³å®šæ€§å’Œæ‰©å±•æ€§ã€‚

## å‚è€ƒèµ„æº

- [tiptap-comment-extension](https://github.com/sereneinserenade/tiptap-comment-extension)
- [Tiptap å®˜æ–¹æ–‡æ¡£](https://tiptap.dev)
- [Yjs å®˜æ–¹æ–‡æ¡£](https://docs.yjs.dev)
