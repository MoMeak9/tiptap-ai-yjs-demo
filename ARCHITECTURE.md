# è¯„è®ºåŠŸèƒ½æ¼”ç¤ºæµç¨‹

## è§†è§‰æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç•Œé¢ (æµè§ˆå™¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Tiptap ç¼–è¾‘å™¨      â”‚      â”‚    è¯„è®ºä¾§è¾¹æ          â”‚    â”‚
â”‚  â”‚                      â”‚      â”‚                      â”‚    â”‚
â”‚  â”‚  æ¬¢è¿ä½¿ç”¨ Tiptap    â”‚â—„â”€â”€â”€â”€â”€â”¤  ğŸ’¬ è¯„è®º             â”‚    â”‚
â”‚  â”‚  åä½œç¼–è¾‘å™¨! ğŸ‰     â”‚      â”‚  â”œâ”€ è¯„è®º 1          â”‚    â”‚
â”‚  â”‚  â–²                  â”‚      â”‚  â”‚  ğŸ“ ğŸ—‘ï¸           â”‚    â”‚
â”‚  â”‚  â””â”€ è¯„è®ºæ ‡è®°        â”‚      â”‚  â”œâ”€ è¯„è®º 2          â”‚    â”‚
â”‚  â”‚                      â”‚      â”‚  â””â”€ è¯„è®º 3          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚ WebSocket
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WebSocket æœåŠ¡å™¨ (ws://localhost:1234)          â”‚
â”‚                      Yjs Document                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æ–‡æ¡£å†…å®¹ (Text)â”‚         â”‚  è¯„è®ºæ•°æ® (Map)  â”‚          â”‚
â”‚  â”‚                 â”‚         â”‚                  â”‚          â”‚
â”‚  â”‚  Y.Text         â”‚         â”‚  Y.Map           â”‚          â”‚
â”‚  â”‚  - æ®µè½ 1       â”‚         â”‚  - comment1: {}  â”‚          â”‚
â”‚  â”‚  - æ®µè½ 2       â”‚         â”‚  - comment2: {}  â”‚          â”‚
â”‚  â”‚  - ...          â”‚         â”‚  - ...           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚ åŒæ­¥
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å…¶ä»–å®¢æˆ·ç«¯ (å®æ—¶åŒæ­¥)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµå‘

### 1. æ·»åŠ è¯„è®º

```
ç”¨æˆ·é€‰ä¸­æ–‡æœ¬
    â†“
ç‚¹å‡» "ğŸ’¬ è¯„è®º" æŒ‰é’®
    â†“
CommentUI.addCommentFromSelection()
    â†“
CommentManager.addComment()
    â†“
ç”Ÿæˆ commentId
    â†“
å­˜å‚¨åˆ° Yjs Map: commentsMap.set(commentId, data)
    â†“
Editor.commands.setComment(commentId)
    â†“
æ·»åŠ  Mark æ ‡è®°åˆ°æ–‡æœ¬
    â†“
Yjs è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–å®¢æˆ·ç«¯
    â†“
å…¶ä»–å®¢æˆ·ç«¯æ”¶åˆ°æ›´æ–°
    â†“
CommentManager.observe è§¦å‘
    â†“
CommentUI é‡æ–°æ¸²æŸ“
```

### 2. ç¼–è¾‘è¯„è®º

```
ç”¨æˆ·ç‚¹å‡»è¯„è®ºé¡¹
    â†“
CommentUI æ¿€æ´»è¯„è®º
    â†“
ç”¨æˆ·ä¿®æ”¹å†…å®¹
    â†“
textarea.oninput è§¦å‘
    â†“
CommentManager.updateComment(id, content)
    â†“
æ›´æ–° Yjs Map
    â†“
è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–å®¢æˆ·ç«¯
```

### 3. æ·»åŠ å›å¤

```
ç”¨æˆ·è¾“å…¥å›å¤å†…å®¹
    â†“
ç‚¹å‡» "å›å¤" æŒ‰é’®
    â†“
CommentManager.addReply(commentId, content)
    â†“
è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    â†“
æ›´æ–°è¯„è®ºçš„ replies æ•°ç»„
    â†“
æ›´æ–° Yjs Map
    â†“
è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–å®¢æˆ·ç«¯
    â†“
CommentUI é‡æ–°æ¸²æŸ“å›å¤åˆ—è¡¨
```

### 4. åˆ é™¤è¯„è®º

```
ç”¨æˆ·ç‚¹å‡» ğŸ—‘ï¸ æŒ‰é’®
    â†“
ç¡®è®¤åˆ é™¤
    â†“
Editor.commands.unsetComment(commentId)
    â†“
ç§»é™¤æ–‡æœ¬ä¸Šçš„ Mark æ ‡è®°
    â†“
CommentManager.deleteComment(commentId)
    â†“
ä» Yjs Map åˆ é™¤
    â†“
è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–å®¢æˆ·ç«¯
    â†“
æ‰€æœ‰å®¢æˆ·ç«¯ç§»é™¤è¯„è®ºå’Œæ ‡è®°
```

## å…³é”®ç»„ä»¶äº¤äº’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Comment.js    â”‚ (Tiptap Mark Extension)
â”‚                 â”‚
â”‚ - setComment    â”‚â—„â”€â”€â”€â”€â”€â”€â”
â”‚ - unsetComment  â”‚       â”‚
â”‚ - toggleComment â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
        â–²                 â”‚
        â”‚                 â”‚
        â”‚ å‘½ä»¤è°ƒç”¨         â”‚
        â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  CommentUI.js    â”‚      â”‚
â”‚                  â”‚      â”‚
â”‚ - æ¸²æŸ“è¯„è®ºåˆ—è¡¨   â”‚      â”‚
â”‚ - å¤„ç†ç”¨æˆ·äº¤äº’   â”‚      â”‚
â”‚ - æ›´æ–°ç•Œé¢æ˜¾ç¤º   â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
        â–²                 â”‚
        â”‚                 â”‚
        â”‚ æ•°æ®è®¿é—®         â”‚
        â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  CommentManager.js   â”‚  â”‚
â”‚                      â”‚  â”‚
â”‚ - addComment         â”‚â”€â”€â”˜
â”‚ - updateComment      â”‚
â”‚ - deleteComment      â”‚
â”‚ - addReply           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²
        â”‚
        â”‚ Yjs Map æ“ä½œ
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Yjs Map     â”‚
â”‚   (comments)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²
        â”‚
        â”‚ WebSocket åŒæ­¥
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket         â”‚
â”‚  Provider          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæŠ€æœ¯ç‚¹

### 1. CRDT (Yjs)
- æ— å†²çªçš„æ•°æ®å¤åˆ¶
- è‡ªåŠ¨åˆå¹¶å¹¶å‘ä¿®æ”¹
- æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

### 2. Mark æ ‡è®° (Tiptap)
- è½»é‡çº§æ–‡æœ¬è£…é¥°
- æ”¯æŒé‡å 
- æ˜“äºåºåˆ—åŒ–

### 3. Observer æ¨¡å¼
- ç›‘å¬æ•°æ®å˜åŒ–
- è‡ªåŠ¨æ›´æ–° UI
- è§£è€¦ç»„ä»¶

### 4. WebSocket åŒæ­¥
- å®æ—¶åŒå‘é€šä¿¡
- ä½å»¶è¿ŸåŒæ­¥
- è‡ªåŠ¨é‡è¿

## æ€§èƒ½ä¼˜åŒ–

1. **è™šæ‹Ÿæ»šåŠ¨**: å¤§é‡è¯„è®ºæ—¶ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨
2. **é˜²æŠ–å¤„ç†**: è¾“å…¥æ—¶å»¶è¿Ÿæ›´æ–°
3. **å¢é‡æ¸²æŸ“**: åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
4. **äº‹ä»¶å§”æ‰˜**: å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡

## å®‰å…¨è€ƒè™‘

1. **XSS é˜²æŠ¤**: è¯„è®ºå†…å®¹è½¬ä¹‰
2. **æƒé™éªŒè¯**: æ£€æŸ¥ç”¨æˆ·æ“ä½œæƒé™
3. **é€Ÿç‡é™åˆ¶**: é˜²æ­¢æ¶æ„æ“ä½œ
4. **å†…å®¹å®¡æ ¸**: æ•æ„Ÿè¯è¿‡æ»¤

## æ‰©å±•æ€§è®¾è®¡

- æ¨¡å—åŒ–æ¶æ„,æ˜“äºæ‰©å±•
- æ’ä»¶åŒ–æ¥å£
- å¯é…ç½®é€‰é¡¹
- ä¸»é¢˜å®šåˆ¶æ”¯æŒ
