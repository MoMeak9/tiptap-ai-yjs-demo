# Tiptap ååŒè¯„è®ºåŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªç±»ä¼¼ Google Docs çš„è¯„è®ºç³»ç»Ÿ,å¹¶ä¸ Yjs ååŒç¼–è¾‘å®Œç¾é›†æˆã€‚å¤šä¸ªç”¨æˆ·å¯ä»¥åœ¨åŒä¸€æ–‡æ¡£ä¸Šæ·»åŠ ã€ç¼–è¾‘å’Œå›å¤è¯„è®º,æ‰€æœ‰æ“ä½œå®æ—¶åŒæ­¥ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. è¯„è®ºæ‰©å±• (Comment Extension)
- âœ… åŸºäº Tiptap Mark å®ç°
- âœ… æ”¯æŒåœ¨ä»»æ„æ–‡æœ¬ä¸Šæ·»åŠ è¯„è®ºæ ‡è®°
- âœ… å¯é€šè¿‡ `setComment`ã€`unsetComment`ã€`toggleComment` å‘½ä»¤æ“ä½œ
- âœ… æ”¯æŒé”®ç›˜å¿«æ·é”® `Ctrl+Shift+M` å¿«é€Ÿæ·»åŠ è¯„è®º
- âœ… è‡ªåŠ¨é«˜äº®è¯„è®ºæ–‡æœ¬(é»„è‰²èƒŒæ™¯)

### 2. è¯„è®ºç®¡ç†å™¨ (CommentManager)
- âœ… ä½¿ç”¨ Yjs Map å­˜å‚¨è¯„è®ºæ•°æ®,å®ç°å¤šäººååŒ
- âœ… æ”¯æŒæ·»åŠ ã€æ›´æ–°ã€åˆ é™¤è¯„è®º
- âœ… æ”¯æŒæ·»åŠ å’Œåˆ é™¤è¯„è®ºå›å¤
- âœ… è‡ªåŠ¨åŒæ­¥è¯„è®ºæ•°æ®åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
- âœ… è®°å½•è¯„è®ºä½œè€…ã€æ—¶é—´ç­‰å…ƒæ•°æ®

### 3. è¯„è®ºç•Œé¢ (CommentUI)
- âœ… å›ºå®šåœ¨å³ä¾§çš„è¯„è®ºé¢æ¿
- âœ… å¯æŠ˜å /å±•å¼€é¢æ¿
- âœ… ç‚¹å‡»è¯„è®ºå¯å®šä½åˆ°å¯¹åº”æ–‡æœ¬
- âœ… æ”¯æŒå®æ—¶ç¼–è¾‘è¯„è®ºå†…å®¹
- âœ… æ”¯æŒæ·»åŠ å’ŒæŸ¥çœ‹å›å¤
- âœ… æ˜¾ç¤ºè¯„è®ºä½œè€…å¤´åƒå’Œé¢œè‰²
- âœ… å‹å¥½çš„æ—¶é—´æ˜¾ç¤º(åˆšåˆšã€Xåˆ†é’Ÿå‰ç­‰)

## ä½¿ç”¨æ–¹æ³•

### æ·»åŠ è¯„è®º

1. **é€šè¿‡å·¥å…·æ **:
   - é€‰ä¸­è¦è¯„è®ºçš„æ–‡æœ¬
   - ç‚¹å‡»å·¥å…·æ çš„ "ğŸ’¬ è¯„è®º" æŒ‰é’®
   - åœ¨å³ä¾§é¢æ¿è¾“å…¥è¯„è®ºå†…å®¹

2. **é€šè¿‡å¿«æ·é”®**:
   - é€‰ä¸­æ–‡æœ¬
   - æŒ‰ `Ctrl+Shift+M` (Mac: `Cmd+Shift+M`)
   - åœ¨å³ä¾§é¢æ¿è¾“å…¥è¯„è®ºå†…å®¹

### ç¼–è¾‘è¯„è®º

1. ç‚¹å‡»è¯„è®ºé¡¹æ¿€æ´»
2. åœ¨æ–‡æœ¬æ¡†ä¸­ä¿®æ”¹å†…å®¹
3. å†…å®¹è‡ªåŠ¨ä¿å­˜å¹¶åŒæ­¥

### å›å¤è¯„è®º

1. åœ¨è¯„è®ºé¡¹åº•éƒ¨çš„è¾“å…¥æ¡†è¾“å…¥å›å¤
2. ç‚¹å‡» "å›å¤" æŒ‰é’®æˆ–æŒ‰ Enter é”®
3. å›å¤ä¼šå®æ—¶æ˜¾ç¤ºå¹¶åŒæ­¥

### åˆ é™¤è¯„è®º

- ç‚¹å‡»è¯„è®ºé¡¹å³ä¸Šè§’çš„ ğŸ—‘ï¸ æŒ‰é’®
- ç¡®è®¤ååˆ é™¤,åŒæ—¶ç§»é™¤æ–‡æœ¬ä¸Šçš„æ ‡è®°

### å®šä½è¯„è®º

- ç‚¹å‡»è¯„è®ºé¡¹å³ä¸Šè§’çš„ ğŸ“ æŒ‰é’®
- ç¼–è¾‘å™¨ä¼šè‡ªåŠ¨æ»šåŠ¨å¹¶é€‰ä¸­å¯¹åº”æ–‡æœ¬

## æŠ€æœ¯å®ç°

### 1. Yjs é›†æˆ

è¯„è®ºæ•°æ®å­˜å‚¨åœ¨ Yjs çš„ Map ç»“æ„ä¸­:

```javascript
// è¯„è®ºæ•°æ®ç»“æ„
{
  "commentId": {
    content: "è¯„è®ºå†…å®¹",
    author: "ç”¨æˆ·å",
    authorColor: "#667eea",
    createdAt: "2023-11-26T10:00:00.000Z",
    updatedAt: "2023-11-26T10:05:00.000Z",
    replies: [
      {
        id: "replyId",
        content: "å›å¤å†…å®¹",
        author: "ç”¨æˆ·å",
        authorColor: "#667eea",
        createdAt: "2023-11-26T10:10:00.000Z"
      }
    ]
  }
}
```

### 2. å®æ—¶åŒæ­¥

- ä½¿ç”¨ Yjs Map çš„ `observe` æ–¹æ³•ç›‘å¬å˜åŒ–
- å½“ä»»ä½•å®¢æˆ·ç«¯ä¿®æ”¹è¯„è®ºæ—¶,è‡ªåŠ¨è§¦å‘æ‰€æœ‰å®¢æˆ·ç«¯æ›´æ–°
- é€šè¿‡ WebSocket Provider å®ç°ä½å»¶è¿ŸåŒæ­¥

### 3. Mark æ ‡è®°

- è¯„è®ºé€šè¿‡ Tiptap Mark æ ‡è®°å®ç°
- æ¯ä¸ªè¯„è®ºæ ‡è®°åŒ…å«å”¯ä¸€çš„ `commentId`
- æ”¯æŒå¤šä¸ªè¯„è®ºæ ‡è®°é‡å 

### 4. çŠ¶æ€ç®¡ç†

- ä½¿ç”¨ `activeCommentId` è·Ÿè¸ªå½“å‰æ¿€æ´»çš„è¯„è®º
- é€‰åŒºå˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ¿€æ´»çŠ¶æ€
- ç¡®ä¿å¤šç”¨æˆ·ç¼–è¾‘æ—¶çŠ¶æ€ä¸€è‡´

## ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ extensions/
â”‚   â”œâ”€â”€ comment.js          # è¯„è®º Mark æ‰©å±•
â”‚   â”œâ”€â”€ commentManager.js   # è¯„è®ºæ•°æ®ç®¡ç†
â”‚   â””â”€â”€ commentUI.js        # è¯„è®ºç•Œé¢ç»„ä»¶
â””â”€â”€ main.js                 # ä¸»å…¥å£,é›†æˆæ‰€æœ‰åŠŸèƒ½
```

## API å‚è€ƒ

### Comment Extension

```javascript
// é…ç½®è¯„è®ºæ‰©å±•
Comment.configure({
  HTMLAttributes: {
    class: 'tiptap-comment',
  },
  onCommentActivated: (commentId) => {
    // è¯„è®ºæ¿€æ´»æ—¶çš„å›è°ƒ
  },
})

// å‘½ä»¤
editor.commands.setComment(commentId)     // æ·»åŠ è¯„è®ºæ ‡è®°
editor.commands.unsetComment(commentId)   // ç§»é™¤è¯„è®ºæ ‡è®°
editor.commands.toggleComment(commentId)  // åˆ‡æ¢è¯„è®ºæ ‡è®°
```

### CommentManager

```javascript
const manager = new CommentManager(ydoc, provider)

// æ·»åŠ è¯„è®º
const commentId = manager.addComment('è¯„è®ºå†…å®¹')

// æ›´æ–°è¯„è®º
manager.updateComment(commentId, 'æ–°å†…å®¹')

// åˆ é™¤è¯„è®º
manager.deleteComment(commentId)

// æ·»åŠ å›å¤
manager.addReply(commentId, 'å›å¤å†…å®¹')

// åˆ é™¤å›å¤
manager.deleteReply(commentId, replyId)

// è·å–è¯„è®ºåˆ—è¡¨
const comments = manager.getComments()

// è®¾ç½®æ¿€æ´»è¯„è®º
manager.setActiveComment(commentId)

// ç›‘å¬å˜åŒ–
manager.onUpdate((comments) => {
  console.log('è¯„è®ºå·²æ›´æ–°', comments)
})
```

### CommentUI

```javascript
const ui = new CommentUI(editor, commentManager)

// ä»é€‰åŒºæ·»åŠ è¯„è®º
ui.addCommentFromSelection()

// æ˜¾ç¤º/éšè—é¢æ¿
ui.show()
ui.hide()
ui.toggle()

// é”€æ¯
ui.destroy()
```

## æ ·å¼å®šåˆ¶

è¯„è®ºæ ·å¼å¯ä»¥åœ¨ `src/styles.css` ä¸­è‡ªå®šä¹‰:

```css
/* è¯„è®ºæ ‡è®°æ ·å¼ */
.tiptap-comment {
  background-color: #fef3c7;
  border-bottom: 2px solid #f59e0b;
}

/* è¯„è®ºé¢æ¿æ ·å¼ */
.comment-sidebar {
  width: 360px;
  /* å…¶ä»–æ ·å¼... */
}
```

## æœ€ä½³å®è·µ

1. **æ€§èƒ½ä¼˜åŒ–**: è¯„è®ºæ•°æ®é€šè¿‡ Yjs è‡ªåŠ¨åˆå¹¶å’Œä¼˜åŒ–,æ— éœ€æ‹…å¿ƒå†²çª
2. **ç”¨æˆ·ä½“éªŒ**: è¯„è®ºæ¿€æ´»æ—¶è‡ªåŠ¨èšç„¦,æ–¹ä¾¿å¿«é€Ÿç¼–è¾‘
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ“ä½œéƒ½æœ‰æ ¡éªŒ,ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **å“åº”å¼è®¾è®¡**: è¯„è®ºé¢æ¿åœ¨ç§»åŠ¨ç«¯è‡ªé€‚åº”

## æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒå¯Œæ–‡æœ¬è¯„è®º(ç²—ä½“ã€æ–œä½“ç­‰)
- [ ] æ”¯æŒè¯„è®ºçº¿ç¨‹(åµŒå¥—å›å¤)
- [ ] æ”¯æŒè¯„è®ºè§£å†³çŠ¶æ€
- [ ] æ”¯æŒ@æåŠç”¨æˆ·
- [ ] æ”¯æŒè¯„è®ºå¯¼å‡º
- [ ] æ”¯æŒè¯„è®ºæœç´¢å’Œè¿‡æ»¤

## å‚è€ƒèµ„æº

- [Tiptap å®˜æ–¹æ–‡æ¡£](https://tiptap.dev)
- [Yjs å®˜æ–¹æ–‡æ¡£](https://docs.yjs.dev)
- [tiptap-comment-extension](https://github.com/sereneinserenade/tiptap-comment-extension)

## License

MIT
